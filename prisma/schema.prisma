// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
  mobile String?
  password String?
  role     String  @default("user")
  
  // Verification fields
  isVerified             Boolean   @default(false)
  verificationCode       String?
  verificationExpiry     DateTime?
  verificationResendCount Int       @default(0)
  
  // Account status
  isBlocked              Boolean   @default(false)
  
  posts Post[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  portfolios Portfolio[] 
}

model Post {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  Int?
  author    User?    @relation(fields: [authorId], references: [id])
}

model Portfolio {
  id        String   @id @default(uuid())
  userId    Int
  name      String
  currency  String   @default("INR")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  transactions Transaction[]
  fundTransactions FundTransaction[]
}

model Transaction {
  id          String   @id @default(uuid())
  portfolioId String
  tradeDate   DateTime
  ticker      String
  side        String   // BUY | SELL
  quantity    Decimal  @db.Decimal(30,6)
  price       Decimal  @db.Decimal(30,6)
  fees        Decimal? @db.Decimal(30,6)
  notes       String?

  portfolio Portfolio @relation(fields: [portfolioId], references: [id])
}

model FundTransaction {
  id          String   @id @default(uuid())
  portfolioId String
  type        String   // DEPOSIT | WITHDRAWAL
  amount      Decimal  @db.Decimal(30,6)
  date        DateTime @default(now())
  notes       String?

  portfolio Portfolio @relation(fields: [portfolioId], references: [id])
}

model DailyPrice {
  ticker    String
  tradeDate DateTime
  open      Decimal? @db.Decimal(30,6)
  high      Decimal? @db.Decimal(30,6)
  low       Decimal? @db.Decimal(30,6)
  close     Decimal? @db.Decimal(30,6)
  volume    BigInt?
  vwap      Decimal? @db.Decimal(30,6)

  @@id([ticker, tradeDate])
  @@map("daily_prices")
}

model CorporateAction {
  id          Int      @id @default(autoincrement())
  symbol      String
  companyName String
  series      String?
  subject     String
  exDate      DateTime?
  recDate     DateTime?
  faceValue   String?
  actionType  String
  createdAt   DateTime @default(now())
  
  @@index([symbol])
  @@index([exDate])
  @@map("corporate_actions")
}

model InsiderTrading {
  id              Int      @id @default(autoincrement())
  symbol          String
  companyName     String
  acqName         String
  transactionType String
  securities      Decimal  @db.Decimal(30,2)
  price           Decimal? @db.Decimal(30,2)
  value           Decimal? @db.Decimal(30,2)
  secAcqPromoter  String?
  secType         String?
  afterSec        Decimal? @db.Decimal(30,2)
  mode             String?
  remarks         String?
  broadcastDate   DateTime?
  createdAt       DateTime  @default(now())
  
  @@index([symbol])
  @@index([broadcastDate])
  @@map("insider_trading")
}

model IndexClose {
  id        String   @id @default(uuid())
  indexName String
  asOf      DateTime
  open      Decimal? @db.Decimal(30,6)
  high      Decimal? @db.Decimal(30,6)
  low       Decimal? @db.Decimal(30,6)
  close     Decimal? @db.Decimal(30,6)
  vwap      Decimal? @db.Decimal(30,6)
  volume    BigInt?

  @@index([indexName, asOf])
  @@map("index_closes")
}

model IndexWeight {
  id        String  @id @default(uuid())
  indexName String
  ticker    String
  security  String?
  weight    Decimal? @db.Decimal(10,4)
  asOf      DateTime

  @@index([indexName, ticker, asOf])
  @@map("index_weights")
}

model Fundamental {
  ticker              String
  asOf                DateTime
  periodType          String
  revenue             Decimal? @db.Decimal(30,6)
  netIncome           Decimal? @db.Decimal(30,6)
  totalAssets         Decimal? @db.Decimal(30,6)
  totalLiabilities    Decimal? @db.Decimal(30,6)
  cash                Decimal? @db.Decimal(30,6)
  shareholdersEquity  Decimal? @db.Decimal(30,6)
  eps                 Decimal? @db.Decimal(30,6)
  peRatio             Decimal? @db.Decimal(30,6)
  roe                 Decimal? @db.Decimal(30,6)
  roic                Decimal? @db.Decimal(30,6)
  rawJson             Json?

  @@id([ticker, asOf, periodType])
  @@map("fundamentals")
}

model Index {
  id       String  @id @default(uuid())
  name     String  @unique
  display  String?
  createdAt DateTime @default(now())
}

model IndexPoint {
  id String @id @default(uuid())
  indexName String
  time DateTime
  open Decimal? @db.Decimal(30,6)
  high Decimal? @db.Decimal(30,6)
  low Decimal? @db.Decimal(30,6)
  close Decimal? @db.Decimal(30,6)
  volume BigInt?
  @@index([indexName, time])
}

model CorporateAnnouncement {
  id                String   @id @default(cuid())
  symbol            String
  companyName       String
  subject           String
  details           String?
  broadcastDateTime DateTime
  attachment        String?
  createdAt         DateTime @default(now())

  @@index([broadcastDateTime])
}

model IndexQuote {
  id              String   @id @default(cuid())
  indexName       String   @unique
  lastPrice       String
  change          String
  pChange         String
  open            String?
  high            String?
  low             String?
  previousClose   String?
  yearHigh        String?
  yearLow         String?
  peRatio         String?
  pbRatio         String?
  dividendYield   String?
  marketStatus    String?
  advances        Int?
  declines        Int?
  unchanged       Int?
  totalTradedVolume String?
  totalTradedValue  String?
  updatedAt       DateTime @updatedAt
  timestamp       DateTime @default(now())
}

model IndexHeatmapItem {
  id              String   @id @default(cuid())
  indexName       String
  symbol          String
  lastPrice       Decimal  @db.Decimal(30,6)
  change          Decimal  @db.Decimal(30,6)
  pChange         Decimal  @db.Decimal(30,6)
  volume          BigInt?
  value           Decimal? @db.Decimal(30,6)
  high            Decimal? @db.Decimal(30,6)
  low             Decimal? @db.Decimal(30,6)
  yearHigh        Decimal? @db.Decimal(30,6)
  yearLow         Decimal? @db.Decimal(30,6)
  updatedAt       DateTime @updatedAt

  @@unique([indexName, symbol])
  @@index([indexName])
}

model MarketSnapshot {
  id        String   @id @default(uuid())
  type      String   // gainers | losers | advance | deals
  payload   Json
  capturedAt DateTime @default(now())

  @@index([type, capturedAt])
}

model Alert {
  id        String   @id @default(uuid())
  userId    Int?
  type      String   // volume_spike | price_jump | price_above | price_below
  symbol    String?
  condition Json
  triggered Boolean  @default(false)
  triggeredAt DateTime?
  seen      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model AIInsight {
  id        String   @id @default(uuid())
  snapshotId String
  summary   String
  createdAt DateTime @default(now())
}

model SavedScreen {
  id        Int      @id @default(autoincrement())
  userId    Int
  name      String
  filters   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FinancialScore {
  id              String   @id @default(uuid())
  symbol          String
  fScore          Int      @default(0)
  roa             Decimal? @db.Decimal(10,4)
  roaChange       Decimal? @db.Decimal(10,4)
  cfo             Decimal? @db.Decimal(10,4)
  cfoVsNi         Decimal? @db.Decimal(10,4)
  currentRatio    Decimal? @db.Decimal(10,4)
  currentRatioChg Decimal? @db.Decimal(10,4)
  leverage        Decimal? @db.Decimal(10,4)
  leverageChange  Decimal? @db.Decimal(10,4)
  sharesChange    Decimal? @db.Decimal(10,4)
  grossMargin     Decimal? @db.Decimal(10,4)
  marginChange    Decimal? @db.Decimal(10,4)
  assetTurnover   Decimal? @db.Decimal(10,4)
  turnoverChange  Decimal? @db.Decimal(10,4)
  periodType      String   @default("annual")
  asOf            DateTime @default(now())
  createdAt       DateTime @default(now())

  @@unique([symbol, periodType, asOf])
  @@index([symbol])
  @@map("financial_scores")
}